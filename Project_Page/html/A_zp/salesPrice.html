<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>销售报价单</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
		<link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" href="../../css/font.css">
		<link rel="stylesheet" href="../../css/xadmin.css">
		<script src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../lib/layui/layui.js" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/xadmin.js"></script>
		<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
		<!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	</head>
	<style>
		.xscz {
			margin-left: 35px;
			width: 150px;
		}
	</style>
	<script type="text/javascript">
		window.onload = function() {
			//去掉默认的contextmenu事件，否则会和右键事件同时出现。
			document.oncontextmenu = function(e) {
				e.preventDefault();
			};
			document.getElementById("xsth").onmousedown = function(e) {
				if(e.button == 2) {
					layer.open({
						title: '请选择操作',
						content: '<select class=xscz onblur=xsxzcz(this)><option value=1>新增</option><option value=2>修改</option><option value=3>删除</option><option value=4>审核</option></select>'

					});
				}
			}
		}

		function xsxzcz(obj) {
			//alert($(obj).val());
			if($(obj).val() == 1) {
				$("input").prop("readonly", false);
				$("select").prop("disabled", false);
				$("textarea").prop("readonly", false);
			}
			layer.closeAll();
		}
	</script>

	<body>
		<div class="layui-container">
			<div style="border: 1px solid pink;" id="xsth">
				<div class="layui-col-md10 layui-col-md-offset2"></div>
				<div class="layui-row">
					<div class="layui-col-md5 layui-col-md-offset2">
						<span class="layui-col-md3" class="" >客户</span>
						<input id="customerName" ondblclick="b()" type="text" class="layui-col-md-offset1" readonly="readonly" />
					</div>
					<div class="layui-col-md5">
						<span class="layui-col-md2" >单据日期</span> <input id="sqDocumentTime" type="date" style="width: 157px;" class="layui-col-md-offset1" readonly="readonly" />
					</div><br /><br />
					<div class="layui-col-md5 layui-col-md-offset2">
						<span class="layui-col-md3">送货地址</span> <input id="sqDeliveryAddress" type="text" class="layui-col-md-offset1 " readonly="readonly" />
					</div>
					<div class="layui-col-md5">
						<span class="layui-col-md2">单据号码</span> <input id="sqId" type="text" class="layui-col-md-offset1 " readonly="readonly" />
					</div><br /><br />
					<div class="layui-col-md5 layui-col-md-offset2">
						<span class="layui-col-md3">有效日期</span> <input id="sqEffectiveTime" type="date" style="width: 157px;" class="layui-col-md-offset1" readonly="readonly" />
					</div>
					<div class="layui-col-md5">
						<span class="layui-col-md2" id="">币别</span> <input id="currencyName" type="text" class="layui-col-md-offset1 " readonly="readonly" />
					</div><br /><br />
					<div class="layui-col-md5 layui-col-md-offset2">
						<span class="layui-col-md3">单价是否含税</span>
						<select id="sqTax" name="" style="width: 163px;height: 25px;" class="layui-col-md-offset1" disabled="disabled">
							<option id="sqTax1" value="0">未税</option>
							<option id="sqTax2" value="1">含税</option>
						</select>
					</div>
					<div class="layui-col-md5">
						<span class="layui-col-md2">汇率</span> <input id="sqExchangeRate" type="text" class="layui-col-md-offset1" readonly="readonly" />
					</div><br /><br />

					<div class="layui-tab layui-col-md10 layui-col-md-offset2">
						<ul class="layui-tab-title layui-col-md10 layui-col-md-offset2">
							<li class="layui-this">内容</li>
							<li id="sqDocumentTime">备注</li>

						</ul>
						<div class="layui-tab-content layui-col-md10 layui-col-md-offset2">
							<div class="layui-tab-item layui-show layui-tab-content " style="border: 1px solid; overflow-x: scroll; overflow-y: scroll;">
								<table class="layui-table" readonly="readonly">

									<thead onclick="a()">
										<tr>
											<th style="white-space: nowrap;">(栏号)</th>
											<th style="white-space: nowrap;">物料编号</th>
											<th style="white-space: nowrap;">(物料名称)</th>
											<th style="white-space: nowrap;">(规格型号)</th>
											<th style="white-space: nowrap;">(单位名称)</th>
											<th style="white-space: nowrap;">数量</th>
											<th style="white-space: nowrap;">折扣前单价</th>
											<th style="white-space: nowrap;">折数(%)</th>
											<th style="white-space: nowrap;">单价</th>
											<th style="white-space: nowrap;">金额</th>
											<th style="white-space: nowrap;">税率(%)</th>
											<th style="white-space: nowrap;">税额(%)</th>
											<th style="white-space: nowrap;">(含税金额)</th>
											<th style="white-space: nowrap;">赠品</th>
											<th style="white-space: nowrap;">分录备注</th>
										</tr>
									</thead>
									<tbody>

									</tbody>
								</table>
							</div>
							<div class="layui-tab-item layui-col-md12" style="border: 1px solid;">

								<div class="layui-col-md12">
									<span class="layui-col-md2" style="margin-left: 25px;">备注</span><textarea id="sqRemark" style="margin-left: 27px;" readonly="readonly" rows="10" cols="81"></textarea>
								</div>
							</div>
							<div class="layui-tab-item layui-col-md12" style="border: 1px solid gray;">
								<div class="layui-col-md6">
									<span class="layui-col-md3" style="margin-left: 25px;">自定栏一</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									<select name="" style="width: 174px;" class=" layui-col-md-offset1 " disabled="disabled">
										<option value=""></option>
									</select>
								</div>
								<div class="layui-col-md6">
									<span class="layui-col-md3" style="margin-left: 82px;">自定栏二</span>
									<select name="" style="width: 174px;" class=" layui-col-md-offset1" disabled="disabled">
										<option value=""></option>
									</select>
								</div><br /><br />
								<div class="layui-col-md12">
									<span class="layui-col-md2" style="margin-left: 25px;">备注</span><textarea style="margin-left: 27px;" readonly="readonly" rows="10" cols="81"></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="layui-col-md5 layui-col-md-offset2">
						<span class="layui-col-md3">业务人员</span> <input id="staffName" type="text" class="layui-col-md-offset1 " readonly="readonly" />
					</div>
					<div class="layui-col-md5">
						<span class="layui-col-md2">制单人员</span><input id="sqAuditing" type="text" class="layui-col-md-offset1 " readonly="readonly" />
					</div><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
					<div class="layui-col-md5 layui-col-md-offset2" style="padding: 10px 0px 0px 0px;">
						<span class="layui-col-md3">所属部门</span> <input id="departName" type="text" class="layui-col-md-offset1 " readonly="readonly" />
					</div>
					<div class="layui-col-md5" style="padding: 10px 0px 0px 0px;">
						<span class="layui-col-md2">复核人员</span> <input id="sqYn" type="text" class="layui-col-md-offset1" readonly="readonly" />
					</div><br/><br/>

					<div  class="layui-col-md12" style="padding: 20px 0px 0px 0px;">
						<select style="width: 100px;height: 25px; background: #1E9FFF;" class="layui-col-md2 layui-col-md-offset2 " disabled="disabled">
							<option>转单</option>
						</select>
						<select style="width: 100px;height: 25px; background: #1E9FFF;" class="layui-col-md2 " disabled="disabled">
							<option>查询</option>
						</select>
						<select style="width: 100px;height: 25px; background: #1E9FFF;" class="layui-col-md2" disabled="disabled">
							<option>功能</option>
						</select>
					</div>
				</div>
			</div>
		</div>
		<script>
			var f=0
			var flag=false
			var a=true
			var obj={}
			jz(1,1)
			function jz(pageNum,pageSize){
				$.ajax({
					url:"//localhost:8080/SoftwareFactoryProject_/zp/querybaojia",
					data:{
						pageNum:pageNum,
                  		pageSize:pageSize
					},
					dataType: "json",
					success:function(r){ 
						obj=r
						$(r.list).each(function(i,obj){
							$("#customerName").val(obj.customerName)
							$("#sqDocumentTime").val(obj.sqDocumentTime)
							$("#sqDeliveryAddress").val(obj.sqDeliveryAddress)
							$("#sqId").val(obj.sqId)
							$("#sqEffectiveTime").val(obj.sqEffectiveTime)
							$("#currencyName").val(obj.currencyName)
							if(obj.sqTax>0){
								$("#sqTax1").attr("selected","selected")
							}else{
								$("#sqTax2").attr("selected","selected")
							}
							$("#sqExchangeRate").val(obj.sqExchangeRate)
							$("#staffName").val(obj.staffName)
							$("#sqAuditing").val(obj.sqAuditing)
							$("#departName").val(obj.departName)
							$("#sqYn").val(obj.sqYn)
							$("#sqRemark").val(obj.sqRemark)
							$("tbody").html("")
							$(obj.list).each(function(i2,obj2){
								$("tbody").append(""+
									"<tr>"+
									"<td><input name='readonly' id='sqdProdid' value='"+obj2.sqdProdid+"'></td>"+
									"<td><input id='sqdSerno' value='"+obj2.sqdSerno+"'></td>"+
									"<td><input id='sqdProdname' value='"+obj2.sqdProdname+"'></td>"+
									"<td><input id='sqdProdsize' value='"+obj2.sqdProdsize+"'></td>"+
									"<td><input id='sqdUnitname' value='"+obj2.sqdUnitname+"'></td>"+
									"<td><input id='sqdSquantity' value='"+obj2.sqdSquantity+"'></td>"+
									"<td><input id='sqdZkqprice' value='"+obj2.sqdZkqprice+"'></td>"+
									"<td><input id='sqdDiscount' value='"+obj2.sqdDiscount+"'></td>"+
									"<td><input id='sqdUnitprice' value='"+obj2.sqdUnitprice+"'></td>"+
									"<td><input id='sqdPrice' value='"+obj2.sqdPrice+"'></td>"+
									"<td><input id='sqdTaxrate' value='"+obj2.sqdTaxrate+"'></td>"+
									"<td><input id='sqdTaxlimit' value='"+obj2.sqdTaxlimit+"'></td>"+
									"<td><input id='sqdTaxinclusiveprice' value='"+obj2.sqdTaxinclusiveprice+"'></td>"+
									"<td><input id='sqdComplimentart' value='"+obj2.sqdComplimentart+"'></td>"+
									"<td><input id='sqdItemremark' value='"+obj2.sqdItemremark+"'></td>"+
									"</tr>")
							})
						})
						$("table tbody tr td input").attr("readonly","readonly");
					}
				});
			}
			
			
			var state = "";
			
			function subpageTriggerEvent(incident){
				//alert("部门设定页 - 触发事件：" + incident);
				
				if(incident == "goFirstPage"){
					//第一笔
					first()
				} else if(incident == "goPrePage"){
					//上一笔
					left()
				} else if(incident == "goNextPage"){
					//下一笔
					right()
				} else if(incident == "goLastPage"){
					//后一笔
					last()
				} else if(incident == "goInsert"){
					//新增
					toinsert()
				} else if(incident == "save"){
					//保存
					baoc()
				} else if(incident == "cancel"){
					//放弃
					fangqi()
				} else if(incident == "goUpdate"){
					//修改
					toupdate()
				} else if(incident == "delete"){
					//删除
					todelete()
				} else if(incident == "refresh"){
					//刷新
					jz(1,1)
				} else if(incident == "audit"){
					//审核
					sh()
				} else if(incident == "cancelTheAudit"){
					//取消审核
					qxsh()
				}
				
				state = incident;
			}
			function sh(){
				//审核：
				//条件是否允许
				//1、未新增的不能审核
				//2、正在修改还未保存的不能审核
				//2、前面的单据是否审核完成
				if(a){
					//传当前单据编号
					$.ajax({
						type:"post",
	              		url:"http://localhost:8080/SoftwareFactoryProject_/zp/shbaojia",
						data:{sqId:$("#sqId").val()},
	             		success:function(r){
	             			if(r>0){
	             				alert("审核成功！")
	             				a=true
	             			}
	             		}
		          	})
				}else{
					alert("当前不能审核！请先保存！")
				}
			}
			function qxsh(){
				//取消审核：
				//条件是否允许
				//1、已审核的表是否已经关联其他表
			}
			function first(){
				if(obj.pageNum-1==0){
					alert("已经是首页了！")
				}else{
					jz(1,1);
				}
			}
			function left(){
				if(obj.pageNum-1==0){
					alert("这是第一页！")
				}else{
					jz(obj.pageNum-1,1);
				}
			}
			function right(){
				if(obj.pageNum+1<=obj.pages){
					jz(obj.pageNum+1,1)
				}else{
					alert("这是最后一页！")
				}
			}
			function last(){
				if(obj.pageNum+1<=obj.pages){
					jz(obj.pages,1)
				}else{
					alert("已经是尾页了！")
				}
			}
			function toinsert(){
				a=false
				f=1
				$("[readonly='readonly']").each(function(i,obj){
					$(obj).removeAttr("readonly")
				})
				$("#sqTax").removeAttr("disabled")
				flag=true
				$("#customerName").val("")
				$("#sqDocumentTime").val("")
				$("#sqDeliveryAddress").val("")
				$("#sqId").val("")
				$("#sqEffectiveTime").val("")
				$("#currencyName").val("")
				$("#sqTax").val("")
				$("#sqExchangeRate").val("")
				$("#staffName").val("")
				$("#sqAuditing").attr("")
				$("#departName").val("")
				$("#sqYn").val("")
				$("tbody").html("")
				a1()
				//定位当前时间
				layui.use('laydate',function(){
					var laydate=layui.laydate;
					laydate.render({
						elem:'#sqDocumentTime',
						value:new Date(),
						done:function(value,date){}
					})
				})
				//自动编写单据号码**********************
				//未完成
				
				
				//读取当前登录者************************
				//将名字赋值到制单人员处
				
				
			}
			function insert(){
				var customerName=$("#customerName").val()
				var sqDocumentTime=$("#sqDocumentTime").val()
				var sqDeliveryAddress=$("#sqDeliveryAddress").val()
				var sqId=$("#sqId").val()
				var sqEffectiveTime=$("#sqEffectiveTime").val()
				var currencyName=$("#currencyName").val()
				var sqTax=$("#sqTax").val()
				var sqExchangeRate=$("#sqExchangeRate").val()
				var staffName=$("#staffName").val()
				var sqAuditing=$("#sqAuditing").val()
				var departName=$("#departName").val()
				var sqYn=$("#sqYn").val()
				
				var list=[]
				$("table tbody tr").each(function(i,obj){
					var a={}
					$("table tbody tr input").each(function(i2,obj2){
						var attr=$(obj2).attr("id")
						a[attr]=$(obj2).val()
					})
					list.push(a)
				})
				var data={
                  		customerName:customerName,
                  		sqDocumentTime:sqDocumentTime,
                  		sqDeliveryAddress:sqDeliveryAddress,
                  		sqId:sqId,
                  		sqEffectiveTime:sqEffectiveTime,
                  		currencyName:currencyName,
                  		sqTax:sqTax,
                  		sqExchangeRate:sqExchangeRate,
                  		staffName:staffName,
                  		sqAuditing:sqAuditing,
                  		departName:departName,
                  		sqYn:sqYn,
                  		list:list
              		}
				console.log(data)
				$.ajax({
					type:"post",
              		url:"http://localhost:8080/SoftwareFactoryProject_/zp/addbaojia",
              		contentType:"application/json",
					data:JSON.stringify(data),
             		success:function(r){
             			if(r>0){
             				alert("新增成功！")
             				jz(1,1)
             				var a=parseInt(obj.pages)+1
             				jz(a,1)
             				a=true
             			}
             		}
	          	})
			}
			function toupdate(){
				a=false
				f=2
				$("[readonly='readonly']").each(function(i,obj){
					$(obj).removeAttr("readonly")
				})
				$("#sqId").attr("readonly","readonly")
				$("#sqTax").removeAttr("disabled")
				$("[name=readonly]").attr("readonly","readonly")
				$("#sqExchangeRate").val("readonly","readonly")
				flag=true
			}
			function update(){
				var customerName=$("#customerName").val()
				var sqDocumentTime=$("#sqDocumentTime").val()
				var sqDeliveryAddress=$("#sqDeliveryAddress").val()
				var sqId=$("#sqId").val()
				var sqEffectiveTime=$("#sqEffectiveTime").val()
				var currencyName=$("#currencyName").val()
				var sqTax=$("#sqTax").val()
				var sqExchangeRate=$("#sqExchangeRate").val()
				var staffName=$("#staffName").val()
				var sqAuditing=$("#sqAuditing").val()
				var departName=$("#departName").val()
				var sqYn=$("#sqYn").val()
				
				var list=[]
				$("table tbody tr").each(function(i,obj){
					var a={}
					$("table tbody tr input").each(function(i2,obj2){
						var attr=$(obj2).attr("id")
						a[attr]=$(obj2).val()
					})
					list.push(a)
				})
				var data={
                  		customerName:customerName,
                  		sqDocumentTime:sqDocumentTime,
                  		sqDeliveryAddress:sqDeliveryAddress,
                  		sqId:sqId,
                  		sqEffectiveTime:sqEffectiveTime,
                  		currencyName:currencyName,
                  		sqTax:sqTax,
                  		sqExchangeRate:sqExchangeRate,
                  		staffName:staffName,
                  		sqAuditing:sqAuditing,
                  		departName:departName,
                  		sqYn:sqYn,
                  		list:list
              		}
				console.log(data)
				$.ajax({
					type:"post",
              		url:"http://localhost:8080/SoftwareFactoryProject_/zp/updatebaojia",
              		contentType:"application/json",
					data:JSON.stringify(data),
             		success:function(r){
             			if(r>0){
             				alert("修改成功！")
             				a=true
             			}
             		}
	          	})
			}
			function baoc(){
				if(f>1){
					//修改
					update()
				}else{
					//新增
					insert()
				}
			}
			function fangqi(){
				$("[readonly='false']").each(function(i,obj){
					$(obj).attr("readonly","readonly")
				})
				$("#sqTax").attr("disabled","disabled")
				$("#customerId").val("")
				$("#sowDocumentDate").val("")
				$("#sowAddress").val("")
				$("#sowId").val("")
				$("#sowtId").val("")
				$("#currencyId").val("")
				$("#sowPriceIncludeTax").val("")
				$("#sowExchangeRate").val("")
				$("#warehouseId").val("")
				$("#sowForeignTrade").val("")
				$("#sowCertificateNumber").val("")
				$("#sowSaleszkgs").val("")
				$("#sowSalesdate").val("")
				$("#sowSalessktj").val("")
				$("#sowSalesday").val("")
				$("#sowRemark").val("")
				$("#sowBuyer").val("")
				$("#sowAuditing").val("")
				$("#sowBelongsSection").val("")
				$("#sowYn").val("")
				$("#sowProject").val("")
				$("tbody").html("")
			}
			function todelete(){
				var flag=confirm("是否确认删除？")
				if(flag){
					$.ajax({
					type:"post",
              		url:"http://localhost:8080/SoftwareFactoryProject_/zp/deletebaojia",
					data:{sqId:$("#sqId").val()},
             		success:function(r){
             			if(r>0){
             				alert("删除成功！")
             				jz(1,1)
             				var a=parseInt(obj.pages)-1
             				jz(a,1)
             			}
             		}
	          	})
				}
			}
			function a1(){
				if(flag){
					$("tbody").append(`
						<tr>
						<td><input id='sqdProdid'></td>
						<td><input id='sqdSerno'></td>
						<td><input id='sqdProdname'></td>
						<td><input id='sqdProdsize'></td>
						<td><input id='sqdUnitname'></td>
						<td><input id='sqdSquantity'></td>
						<td><input id='sqdZkqprice'></td>
						<td><input id='sqdDiscount'></td>
						<td><input id='sqdUnitprice'></td>
						<td><input id='sqdPrice'></td>
						<td><input id='sqdTaxrate'></td>
						<td><input id='sqdTaxlimit'></td>
						<td><input id='sqdTaxinclusiveprice'></td>
						<td><input id='sqdComplimentart'></td>
						<td><input id='sqdItemremark'></td>
						</tr>
					`)
				}
			}	
			
			function b(){
				//开窗取值
				layer.open({
					type:2,
					content:"a.html",
					success:function(iframe,index){ //iframe=>div
						//获取子页面中body节点,通过jquery查找节点方式进行赋值
						var body = layer.getChildFrame('body', index);  //获取的子页面HTML所有类容
						//var span = body.find("span");
						//alert(span.text())
						/*//获取子页面的窗体对象,通过窗体对象对js中的变量或者函数进行调用
						var iframeWin = window[iframe.find('iframe')[0]['name']]; 
						iframeWin.id = 100;
						iframeWin.printId();*/
					}
					
				});
			}
			
			
			
			
			
			
			
			
			
		</script>

	</body>

</html>